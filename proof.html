<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Submit Proof · IgniteX Hive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./assets/styles.css">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T96TDZ4N9E"></script>
  <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config','G-T96TDZ4N9E');</script>
  <style>
    .form-card{max-width:860px;margin:24px auto}
    .grid-3{display:grid;gap:12px}
    @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,1fr)}}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <img src="./assets/hero.png" class="logo" alt="IgniteX Hive">
      <div class="brand">IgniteX Hive</div>
      <div class="spacer"></div>
      <a class="btn" href="./index.html">Guide</a>
      <a class="btn" href="./manual/index.html">Manual</a>
      <a class="btn" href="./signup.html">Sign‑Up</a>
      <a class="btn" href="./proof.html">Submit Proof</a>
      <a class="btn" href="./index.html#contact" data-nav="Contact">Contact</a>
      <!--<div class="theme"><button id="themeToggle" class="btn" aria-label="Toggle theme">Light Mode</button></div>-->
    </div>
  </nav>

  <main class="container">
    <div class="card form-card">
      <h1>Submit Proof of Transactions</h1>
      <p class="small">Attach 9 screenshots taken on the <strong>same phone</strong>, unedited.</p>

      <div class="notice"><span class="label">Reminder:</span> You should submit after your Luno account is verified and all transfers are complete.</div>

      <form id="proofForm">
        <div class="row two">
          <div>
            <label for="xrpTag">Your XRP Tag ID (10 digits) *</label>
            <input id="xrpTag" name="xrpTag" required pattern="\d{10}" maxlength="10" inputmode="numeric" placeholder="##########">
          </div>
          <div>
            <label for="email">Email Address *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
        </div>

        <div class="row two">
          <div>
            <label for="wallet">Your Wallet Address *</label>
            <input id="wallet" name="wallet" required>
          </div>
          <div>
            <label for="txId">Any one Transaction ID *</label>
            <input id="txId" name="txId" required placeholder="Hash">
          </div>
        </div>

        <h2>Upload Screenshots</h2>
        <div class="row">
          <label>Ignite‑X Hive (Company) — 1 image (≤1MB) *</label>
          <input id="imgCompany" name="imgCompany" type="file" accept=".png,.jpg,.jpeg" required>
        </div>

        <div class="row">
          <label>All 7 Predecessors — 7 images total (≤10MB combined) *</label>
          <input id="imgPred" name="imgPred" type="file" accept=".png,.jpg,.jpeg" multiple required>
          <div class="help">Exactly 7 images recommended.</div>
        </div>

        <div class="row">
          <label>Successor — 1 image (≤1MB) *</label>
          <input id="imgSucc" name="imgSucc" type="file" accept=".png,.jpg,.jpeg" required>
        </div>

        <input type="hidden" name="clientTs" id="clientTs">

        <div class="row">
          <button class="btn" type="submit">Submit</button>
        </div>

        <div class="row">
          <progress id="prog" value="0" max="100" style="display:none;width:100%"></progress>
        </div>
      </form>

      <div id="msg" class="card" style="display:none;margin-top:14px;"></div>
    </div>
  </main>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwSk2SoBcYyS0Su-4CJkhPycpc6EfAPBTDVbXinkH-3hsvAiEnaAnTwOv3BDdL2yJt_/exec'; // replace with your Apps Script Web App URL

    const form = document.getElementById('proofForm');
    const msg  = document.getElementById('msg');
    const prog = document.getElementById('prog');

    async function postWithRetry(fd, tries = 2) {
      let lastErr, lastData;
      for (let i = 0; i < tries; i++) {
        try {
          const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
          // read text first (helps surface HTML error pages)
          const txt = await res.text();
          try { lastData = JSON.parse(txt); } catch { throw new Error('Non-JSON response: ' + txt.slice(0,120)); }
          return { ok: true, data: lastData };
        } catch (e) {
          lastErr = e;
          await new Promise(r => setTimeout(r, 600));
        }
      }
      return { ok: false, error: lastErr?.message || 'network error' };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const tag = (document.getElementById('xrpTag').value || '').trim();
      if (!/^\d{10}$/.test(tag)) return show('❌ XRP Tag ID must be exactly 10 digits.', true);

      const company = document.getElementById('imgCompany').files[0];
      const preds   = Array.from(document.getElementById('imgPred').files || []);
      const succ    = document.getElementById('imgSucc').files[0];

      if (!company || !succ || preds.length !== 7)
        return show('❌ Please attach Company (1), exactly 7 Predecessors, and Successor (1).', true);

      if (company.size > 1 * 1024 * 1024)  return show('❌ Company screenshot must be ≤ 1 MB.', true);
      if (succ.size    > 1 * 1024 * 1024)  return show('❌ Successor screenshot must be ≤ 1 MB.', true);
      const totalPred = preds.reduce((n, f) => n + f.size, 0);
      if (totalPred   > 10 * 1024 * 1024)  return show('❌ Predecessors total must be ≤ 10 MB.', true);

      document.getElementById('clientTs').value = new Date().toISOString();

      try {
        show('Initializing…');

        // 1) initProof
        const fd1 = new FormData();
        fd1.append('action', 'initProof');
        fd1.append('tag', tag);
        fd1.append('clientTs', document.getElementById('clientTs').value);
        const init = await postWithRetry(fd1);
        if (!init.ok || !init.data.ok) return show('❌ initProof failed: ' + (init.data?.error || init.error || 'Unknown'), true);
        const folderURL = init.data.folderURL || '(folder URL not returned)';

        // 2) sequential uploads
        const files = [
          { kind: 'company',  file: company },
          { kind: 'pred1',    file: preds[0] },
          { kind: 'pred2',    file: preds[1] },
          { kind: 'pred3',    file: preds[2] },
          { kind: 'pred4',    file: preds[3] },
          { kind: 'pred5',    file: preds[4] },
          { kind: 'pred6',    file: preds[5] },
          { kind: 'pred7',    file: preds[6] },
          { kind: 'successor',file: succ }
        ];

        prog.style.display = 'block';
        prog.value = 0;

        for (let i = 0; i < files.length; i++) {
          const { kind, file } = files[i];

          const blob = await compressImage(file, kind.startsWith('pred') ? 0.85 : 0.9, 1600);

          // Wrap as a File to guarantee name+type for GAS
          const fname = safeName(file.name || (kind + '.jpg'));
          const fwrap = new File([blob], fname, { type: blob.type || 'image/jpeg' });

          const fd2 = new FormData();
          fd2.append('action', 'uploadProof');
          fd2.append('tag', tag);
          fd2.append('kind', kind);
          fd2.append('clientTs', document.getElementById('clientTs').value);
          // IMPORTANT: field name MUST be "file"
          fd2.append('file', fwrap);

          const up = await postWithRetry(fd2);
          if (!up.ok || !up.data.ok) return show(`❌ Upload failed for ${kind}: ` + (up.data?.error || up.error || 'Unknown'), true);

          // Show a clickable link for each uploaded file
          if (up.data.fileURL) {
            show(`Uploaded ${kind} (${i + 1}/${files.length}) → ${up.data.fileURL}`);
          } else {
            show(`Uploaded ${kind} (${i + 1}/${files.length}). (No fileURL returned)`);
          }

          prog.value = Math.round(((i + 1) / files.length) * 100);
        }

        show(`✅ All proof images uploaded. Folder: ${folderURL}`, false, true);
        form.reset();
        prog.style.display = 'none';

      } catch (err) {
        show('❌ Network error: ' + err.message, true);
      }
    });

    function show(text, isError=false, isSuccess=false) {
      msg.style.display = 'block';
      msg.className = (isError ? 'card error' : (isSuccess ? 'card success' : 'card'));
      msg.textContent = text;
    }
    function safeName(name) { return (name || 'upload.jpg').replace(/[^\w\-.]+/g, '_'); }

    async function compressImage(file, quality=0.9, maxWidth=1600) {
      try {
        if (!('createImageBitmap' in window)) return file;
        const bmp = await createImageBitmap(file);
        const scale = Math.min(1, maxWidth / bmp.width);
        const canvas = document.createElement('canvas');
        canvas.width  = Math.round(bmp.width  * scale);
        canvas.height = Math.round(bmp.height * scale);
        canvas.getContext('2d').drawImage(bmp, 0, 0, canvas.width, canvas.height);
        const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
        return blob || file;
      } catch { return file; }
    }
  </script>
  <!--<script src="./assets/script.js"></script>-->
</body>
</html>
