<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IXH â€“ Upload Proofs</title>
  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="assets/manual.css">
</head>
<body>
  <main class="container">
    <h1 class="title">Upload Payment Proofs</h1>

    <div class="card">
      <form id="proofForm" class="form" enctype="multipart/form-data">
        <div class="grid">
          <div class="field">
            <label for="xrpTag">Your XRP Tag ID (10 digits)</label>
            <input id="xrpTag" name="xrpTag" type="text" class="input" inputmode="numeric" pattern="^\d{10}$" required>
          </div>
          <div class="field">
            <label for="succTag">Successor Tag ID (10 digits)</label>
            <input id="succTag" name="succTag" type="text" class="input" inputmode="numeric" pattern="^\d{10}$" required>
          </div>
        </div>

        <p class="muted">Upload up to 9 images (JPG/PNG). Company + predecessors + successor.</p>

        <div class="field">
          <label>Company Screenshot</label>
          <input type="file" name="imgCompany" accept="image/png,image/jpeg" class="input">
        </div>

        <div class="field">
          <label>Predecessor Screenshots</label>
          <input type="file" name="imgPred" accept="image/png,image/jpeg" multiple class="input">
        </div>

        <div class="field">
          <label>Successor Screenshot</label>
          <input type="file" name="imgSucc" accept="image/png,image/jpeg" class="input">
        </div>

        <div class="actions">
          <button type="submit" class="btn">Upload</button>
          <button type="button" id="finalize" class="btn primary">Finalize & Queue OCR</button>
        </div>
      </form>

      <div id="result" class="result" hidden></div>
    </div>
  </main>

  <script>
    (function(){
      const BASE = new URL(window.location.href);
      const APP_URL = BASE.origin + BASE.pathname.replace(/\/[^\/]*$/, '/exec');

      const form = document.getElementById('proofForm');
      const finalizeBtn = document.getElementById('finalize');
      const result = document.getElementById('result');

      function show(msg, ok) {
        result.hidden = false;
        result.textContent = msg;
        result.className = 'result ' + (ok ? 'ok' : 'err');
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const tag = form.xrpTag.value.trim();
        const succ = form.succTag.value.trim();
        if (!/^\d{10}$/.test(tag)) { show('XRP Tag ID must be 10 digits.', false); return; }
        if (!/^\d{10}$/.test(succ)) { show('Successor Tag ID must be 10 digits.', false); return; }

        const fd = new FormData(form);
        fd.append('action', 'proof');

        try {
          const r = await fetch(APP_URL, { method: 'POST', body: fd });
          const j = await r.json();
          if (j.ok) {
            show('Uploaded. Folder: ' + j.folderURL + ' (' + (j.files||[]).length + ' files)', true);
          } else {
            show('Error: ' + (j.error || 'Unknown'), false);
          }
        } catch (e) {
          show('Network error: ' + e, false);
        }
      });

      finalizeBtn.addEventListener('click', async () => {
        const tag = form.xrpTag.value.trim();
        if (!/^\d{10}$/.test(tag)) { show('XRP Tag ID must be 10 digits.', false); return; }
        const payload = new URLSearchParams();
        payload.set('action','finalizeProof');
        payload.set('xrpTag', tag);
        payload.set('force', 'true'); // let backend enforce counts/locks; adjust if you want strict 9
        try {
          const r = await fetch(APP_URL, { method:'POST', body: payload });
          const j = await r.json();
          if (j.ok) {
            show('Queued for OCR. Folder: ' + (j.folderURL || ''), true);
          } else {
            show('Error: ' + (j.error || 'Unknown'), false);
          }
        } catch (e) {
          show('Network error: ' + e, false);
        }
      });
    })();
  </script>
</body>
</html>
